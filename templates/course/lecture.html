{% extends "base.html" %}
{% block title %} {{ video.title }} | {{ course.title }} {% endblock title %}
{% block head %}{% endblock head %}
{% load humanize %}
{% block body %}
<div class="container-fluid my-3">
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-lg p-3 mb-5 bg-white rounded">
                <div class="card-header">
                    <h4>{{ course.title }}</h4>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ lecture.title }}</h5>
                    <div class="accordion mb-2" id="accordionExample">
                        {% for section in section %}
                        <div class="card">
                            <div class="card-header" id="headingOne{{ section.id }}">
                                <h2 class="mb-0">
                                    <button class="btn btn-link btn-block text-left" type="button"
                                        data-toggle="collapse" data-target="#collapseOne{{ section.id }}"
                                        aria-expanded="{% for lecture in lecture %}{% if lecture.section == section and lecture.id == video.id %}true{% endif %}{% endfor %}" aria-controls="collapseOne{{ section.id }}">
                                        <span class="fas fa-plus-circle"></span> {{ section.title }}
                                    </button>
                                </h2>
                            </div>
                            <div id="collapseOne{{ section.id }}" class="collapse{% for lecture in lecture %}{% if lecture.section == section and lecture.id == video.id %} show{% endif %}{% endfor %}"
                                aria-labelledby="headingOne{{ section.id }}" data-parent="#accordionExample">
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        {% for lecture in lecture %}
                                        {% if lecture.section == section %}
                                        {% if lecture.lecture_type == "NOT PREMIUM" %}
                                        <li class="py-1">
                                            <a href="{{ lecture.lecture_slug }}"
                                               class="{% if lecture.id == video.id %}text-primary font-weight-bold{% else %}text-dark{% endif %}">
                                                {% if lecture.id == video.id %}
                                                <i class="fas fa-play-circle"></i> {{ lecture.title }} <span class="badge badge-primary">Current</span>
                                                {% elif previous_lecture and lecture.id == previous_lecture.id %}
                                                <i class="fas fa-backward"></i> {{ lecture.title }} <span class="badge badge-secondary">Previous</span>
                                                {% elif next_lecture and lecture.id == next_lecture.id %}
                                                <i class="fas fa-forward"></i> {{ lecture.title }} <span class="badge badge-info">Next</span>
                                                {% else %}
                                                {{ lecture.title }}
                                                {% endif %}
                                            </a>
                                        </li>
                                        {% else %}
                                        <li class="py-1">{{ lecture.title }} <span class="badge badge-pill badge-secondary">PREMIUM VIDEO</span></li>
                                        {% endif %}
                                        {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-lg">
                <h5 class="card-header">{{ video.title }}</h5>
                <div class="card-body">

                    <div class="text-center mb-2">
                        <div class="shortcuts-guide">
                            <i class="fas fa-keyboard"></i>
                            Shortcuts: <kbd>Ctrl + ←</kbd> Previous | <kbd>Ctrl + →</kbd> Next | <kbd>Space</kbd> Play/Pause
                        </div>
                    </div>

                    <video-js id="player" class="video-js vjs-fluid"
                              controls
                              preload="auto"
                              data-setup="{}">
                        <source src="{{ video.video_url }}" type="video/youtube" />
                        <p class="vjs-no-js">
                            To view this video please enable JavaScript, and consider upgrading to a web browser that
                            <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                        </p>
                    </video-js>

                    <iframe id="fallback-player" width="100%" height="450" src="{{ video.video_url }}" frameborder="0" allowfullscreen style="display: none;"></iframe>
                    
                    <!-- Navigation buttons below video -->
                    <div class="d-flex justify-content-center align-items-center mt-4 mb-3">
                        {% if previous_lecture %}
                        <a href="{% url 'lecture_detail' course.course_slug previous_lecture.lecture_slug %}"
                           class="btn btn-udemy-nav btn-previous mr-3"
                           title="Previous: {{ previous_lecture.title }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}
                        
                        {% if next_lecture %}
                        <a href="{% url 'lecture_detail' course.course_slug next_lecture.lecture_slug %}"
                           class="btn btn-udemy-nav btn-next ml-3"
                           title="Next: {{ next_lecture.title }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3">
                        {% if user.is_authenticated %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div id="completionStatus">
                                {% if lecture_completed %}
                                <span class="badge badge-success"><i class="fas fa-check"></i> Completed</span>
                                {% else %}
                                <button id="markCompleteBtn" class="btn btn-outline-success btn-sm" onclick="markLectureComplete({{ video.id }})">
                                    <i class="fas fa-check"></i> Mark as Complete
                                </button>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center">
                                <div id="watchProgress" class="text-muted mr-3" style="display: none;">
                                    <small><i class="fas fa-play-circle"></i> <span id="progressText">0% watched</span></small>
                                </div>
                                {% if next_lecture %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="autoPlayToggle" checked>
                                    <label class="form-check-label" for="autoPlayToggle">
                                        <small>Auto-play next</small>
                                    </label>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div id="watchProgressBar" class="progress" style="height: 4px; display: none;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card shadow-lg my-4">
                <div class="card-body">
                    <h3 class="card-title">Comments: ({{ lecture_comment.count }})</h3>
                    <div class="row">
                        <div class="col-md-8">
                            <form action="/courses/lecture/comment" method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <input type="text" class="form-control" name="comment" id="comment"
                                           aria-describedby="text" placeholder="Enter Comment here">
                                </div>
                                <input type="hidden" name="lecture_id" id="lecture_id" value="{{ video.id }}">
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </form>
                        </div>
                    </div>
                    {% for comment in lecture_comment reversed %}
                    <div class="row my-3">
                        <div class="col-md-1"><img src="https://img.icons8.com/doodle/50/000000/user-male.png" /></div>
                        <div class="col-md-11"><b> {{ comment.user.username }}</b> <span class="badge badge-secondary">
                            {{ comment.timestamp | naturaltime }}</span>
                            <div> {{ comment.comment }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock body %}
{% block js %}
<script>
// JavaScript Enhancements
let player;
let lectureId = {{ video.id }};
let isCompleted = {% if lecture_completed %}true{% else %}false{% endif %};
let autoCompleted = false;
let progressInterval;
let hasStartedWatching = false;
let watchedSegments = new Set();
let videoDuration = 0;
let nextLectureUrl = {% if next_lecture %}'{% url "lecture_detail" course.course_slug next_lecture.lecture_slug %}'{% else %}null{% endif %};
let previousLectureUrl = {% if previous_lecture %}'{% url "lecture_detail" course.course_slug previous_lecture.lecture_slug %}'{% else %}null{% endif %};
let autoPlayCountdown = 10;
let countdownInterval = null;

window.addEventListener('load', () => {
    // Check if we came from autoplay
    const autoPlayParam = new URLSearchParams(window.location.search).get('autoplay');
    const returnFromAutoPlay = sessionStorage.getItem('returnFromAutoPlay') === 'true';
    
    if (returnFromAutoPlay) {
        sessionStorage.removeItem('returnFromAutoPlay');
        console.log('Returned from autoplay, video should start automatically');
    }
    
    const autoPlayToggle = document.getElementById('autoPlayToggle');
    if (autoPlayToggle) {
        const savedPreference = localStorage.getItem('courseAutoPlay');
        autoPlayToggle.checked = savedPreference !== null ? savedPreference === 'true' : true;

        autoPlayToggle.addEventListener('change', () => {
            localStorage.setItem('courseAutoPlay', autoPlayToggle.checked);
            console.log('Auto-play preference saved:', autoPlayToggle.checked);
        });
    }

    document.addEventListener('keydown', (event) => {
        if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
            switch (event.key) {
                case 'ArrowLeft':
                    if (event.ctrlKey && previousLectureUrl) {
                        console.log('Keyboard shortcut: Previous lecture');
                        window.location.href = previousLectureUrl;
                    }
                    break;
                case 'ArrowRight':
                    if (event.ctrlKey && nextLectureUrl) {
                        console.log('Keyboard shortcut: Next lecture');
                        window.location.href = nextLectureUrl;
                    }
                    break;
                case ' ':
                    if (player && player.paused !== undefined) {
                        event.preventDefault();
                        player.paused() ? player.play() : player.pause();
                    }
                    break;
            }
        }
    });

    initializePlayer();
});

function initializePlayer() {
    // Check if we came from auto-play
    const autoPlayParam = new URLSearchParams(window.location.search).get('autoplay');
    const shouldAutoPlay = autoPlayParam === 'true';
    
    player = videojs('player', {
        techOrder: ['youtube'],
        sources: [{
            type: 'video/youtube',
            src: '{{ video.video_url }}'
        }],
        autoplay: shouldAutoPlay,
        muted: shouldAutoPlay, // Mute initially if autoplaying (browser requirement)
        youtube: {
            ytControls: 2,
            modestbranding: 1,
            rel: 0,
            showinfo: 0,
            iv_load_policy: 3,
            disablekb: 0,
            fs: 1,
            playsinline: 1,
            color: 'white',
            cc_load_policy: 0,
            enablejsapi: 1
        },
        fluid: true,
        responsive: true
    });

    player.ready(() => {
        console.log('Video.js player is ready, completed status:', isCompleted);
        document.getElementById('fallback-player').style.display = 'none';
        
        // Auto-start if coming from auto-play
        const autoPlayParam = new URLSearchParams(window.location.search).get('autoplay');
        if (autoPlayParam === 'true') {
            console.log('Auto-playing video...');
            // First try to play muted (most browsers require this)
            player.muted(true);
            player.play().then(() => {
                // After successful autoplay, unmute if possible
                setTimeout(() => {
                    player.muted(false);
                }, 1000);
            }).catch(error => {
                console.warn('Auto-play failed:', error);
                // If autoplay fails, unmute and show play button
                player.muted(false);
            });
        }
    });

    player.on('error', (e) => {
        console.error('Video.js player error:', e);
        showFallbackPlayer();
    });

    player.on('play', () => {
        if (!hasStartedWatching) {
            hasStartedWatching = true;
            if (!isCompleted) {
                showProgressTracking();
                console.log('Started watching, showing progress tracking');
            } else {
                console.log('Video already completed, preparing for auto-next');
            }
        }
        startProgressTracking();
    });

    player.on('pause', () => {
        stopProgressTracking();
    });

    player.on('ended', () => {
        stopProgressTracking();
        console.log('Video ended, completed status:', isCompleted);
        
        if (!isCompleted && !autoCompleted) {
            autoCompleted = true;
            console.log('Video ended, marking as complete...');
            markLectureComplete(lectureId, true);
        } else if (isCompleted) {
            // If video is already completed, show auto-next notification directly
            showAutoCompleteNotification();
        }
    });
}

function showFallbackPlayer() {
    console.log('Video.js failed, showing fallback iframe');
    document.getElementById('fallback-player').style.display = 'block';
    if (document.getElementById('watchProgress')) {
        document.getElementById('watchProgress').style.display = 'none';
    }
    if (document.getElementById('watchProgressBar')) {
        document.getElementById('watchProgressBar').style.display = 'none';
    }
}

function markLectureComplete(lectureId, isAutoComplete = false) {
    console.log('markLectureComplete called:', { lectureId, isAutoComplete, isCompleted, autoCompleted });
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found!');
        return;
    }

    fetch('/courses/lecture/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken.value
        },
        body: 'lecture_id=' + lectureId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('completionStatus').innerHTML =
                '<span class="badge badge-success"><i class="fas fa-check"></i> Completed</span>';
            if (isAutoComplete) {
                showAutoCompleteNotification();
            } else {
                alert('Lecture marked as completed!');
            }
            isCompleted = true;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
    });
}

function showProgressTracking() {
    document.getElementById('watchProgress').style.display = 'block';
    document.getElementById('watchProgressBar').style.display = 'block';
}

function startProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
    }

    progressInterval = setInterval(() => {
        if (player) {
            const currentTime = player.currentTime();
            const duration = player.duration();
            
            console.log('Current time:', currentTime, 'Duration:', duration); // Debug log

            if (duration > 0) {
                const progressPercent = Math.round((currentTime / duration) * 100);
                updateProgressDisplay(progressPercent);
                videoDuration = duration; // Update video duration

                const currentSegment = Math.floor((currentTime / duration) * 100);
                const prevSegment = Math.max(0, currentSegment - 1);
                const nextSegment = Math.min(99, currentSegment + 1);
                
                // Add current and adjacent segments to account for seeking
                watchedSegments.add(currentSegment);
                watchedSegments.add(prevSegment);
                watchedSegments.add(nextSegment);

                const uniqueSegmentsWatched = watchedSegments.size;

                if (progressPercent % 10 === 0 && progressPercent > 0) {
                    console.log(`Progress: ${progressPercent}%, Segments: ${uniqueSegmentsWatched}%, Time: ${Math.round(currentTime)}/${Math.round(duration)}s`);
                }

                // Auto-complete if any completion criteria is met
                if (!isCompleted && !autoCompleted && (
                    uniqueSegmentsWatched >= 75 || 
                    progressPercent >= 95 ||
                    (duration - currentTime) <= 5
                )) {
                    console.log('Auto-completion criteria met, marking as complete...');
                    autoCompleted = true;
                    markLectureComplete(lectureId, true);
                }

                if (progressPercent >= 95 && !isCompleted && !autoCompleted) {
                    autoCompleted = true;
                    markLectureComplete(lectureId, true);
                }
            }
        }
    }, 1000);
}

function stopProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

function updateProgressDisplay(percent) {
    try {
        // Make sure percent is a valid number
        percent = Math.max(0, Math.min(100, Math.round(percent)));
        
        // Update text display
        const uniqueSegments = watchedSegments.size;
        const segmentText = uniqueSegments > 1 ? 
            `${percent}% watched (${uniqueSegments}% coverage)` : 
            `${percent}% watched`;
        
        const progressText = document.getElementById('progressText');
        if (progressText) {
            progressText.textContent = segmentText;
        }

        // Update progress bar
        const progressBar = document.querySelector('#watchProgressBar .progress-bar');
        if (progressBar) {
            progressBar.style.width = `${percent}%`;
            progressBar.setAttribute('aria-valuenow', percent);
        }
        
        console.log('Progress updated:', percent + '%'); // Debug log
    } catch (error) {
        console.error('Error updating progress display:', error);
    }
}

function showAutoCompleteNotification() {
    // Hide progress elements if they exist and are visible
    const watchProgress = document.getElementById('watchProgress');
    const watchProgressBar = document.getElementById('watchProgressBar');
    if (watchProgress) watchProgress.style.display = 'none';
    if (watchProgressBar) watchProgressBar.style.display = 'none';

    const autoPlayToggle = document.getElementById('autoPlayToggle');
    const autoPlayEnabled = autoPlayToggle ? autoPlayToggle.checked : false;

    const notification = document.createElement('div');
    notification.id = 'completion-notification';
    notification.className = 'alert alert-success alert-dismissible fade show';

    if (nextLectureUrl) {
        if (autoPlayEnabled) {
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>🎉 Congratulations!</strong> You've completed this lecture!
                        <br><small>Next video will start in <span id="countdown">10</span> seconds...</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary btn-sm me-2" onclick="playNextVideo()">
                            <i class="fas fa-play"></i> Play Next
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelAutoPlay()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>`;
            startNextVideoCountdown();
        } else {
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>🎉 Congratulations!</strong> You've completed this lecture!
                        <br><small>Ready for the next video?</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary btn-sm me-2" onclick="playNextVideo()">
                            <i class="fas fa-play"></i> Play Next
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelAutoPlay()">
                            <i class="fas fa-times"></i> Stay Here
                        </button>
                    </div>
                </div>`;
        }
    } else {
        notification.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>🎉 Congratulations!</strong> You've completed this lecture!
                    <br><small>This is the last video in the course.</small>
                </div>
                <div>
                    <a href="{% url 'course_detail' course.course_slug %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to Course
                    </a>
                </div>
            </div>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>`;
    }
    document.querySelector('.card-body').insertBefore(notification, document.querySelector('.card-body').firstChild);
}

function startNextVideoCountdown() {
    autoPlayCountdown = 10;
    countdownInterval = setInterval(() => {
        const countdownElement = document.getElementById('countdown');
        if (countdownElement) {
            countdownElement.textContent = autoPlayCountdown;
        }
        autoPlayCountdown--;

        if (autoPlayCountdown < 0) {
            clearInterval(countdownInterval);
            playNextVideo();
        }
    }, 1000);
}

function playNextVideo() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    if (nextLectureUrl) {
        // Store the current scroll position in session storage
        sessionStorage.setItem('returnFromAutoPlay', 'true');
        
        // Add autoplay parameter to URL
        const separator = nextLectureUrl.includes('?') ? '&' : '?';
        const autoplayUrl = nextLectureUrl + separator + 'autoplay=true';
        
        console.log('Navigating to next video with autoplay:', autoplayUrl);
        window.location.href = autoplayUrl;
    }
}

function cancelAutoPlay() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    const notification = document.getElementById('completion-notification');
    if (notification) {
        notification.remove();
    }
}
</script>
{% endblock js %}
